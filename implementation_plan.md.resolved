# Chibi Office AI ‚Äî K·∫ø Ho·∫°ch D·ª± √Ån Chi Ti·∫øt

## T·ªïng quan

**Chibi Office AI** (codename: IT Heroes) l√† desktop app m√¥ ph·ªèng "vƒÉn ph√≤ng chibi" ƒë·ªÉ ƒëi·ªÅu ph·ªëi ƒë·ªôi agent (Claude Code Agent Teams) l√†m vi·ªác tr√™n codebase local. M·ªói agent = 1 nh√¢n v·∫≠t chibi, m·ªói folder/project = 1 ph√≤ng ban. H·ªá th·ªëng cho ph√©p t·∫°o task ‚Üí ph√¢n c√¥ng ‚Üí theo d√µi realtime ‚Üí QA gate ‚Üí t·ªïng h·ª£p k·∫øt qu·∫£.

> [!IMPORTANT]
> D·ª± √°n n√†y x√¢y d·ª±ng **t·ª´ ƒë·∫ßu** ‚Äî hi·ªán t·∫°i ch·ªâ c√≥ file [PROJECT_SPEC.md](file:///Users/hainc/claudebot/it-heroes/PROJECT_SPEC.md). K·∫ø ho·∫°ch d∆∞·ªõi ƒë√¢y chia th√†nh 3 Sprint r√µ r√†ng, m·ªói Sprint c√≥ deliverables c·ª• th·ªÉ.

---

## Ph√¢n T√≠ch T√†i Li·ªáu Tham Kh·∫£o

### 1. Auto-Claude (github.com/AndyMik90/Auto-Claude)

| ƒê·∫∑c ƒëi·ªÉm | Chi ti·∫øt |
|---|---|
| **Ki·∫øn tr√∫c** | Monorepo: `apps/backend/` (Python agents, specs, QA pipeline) + `apps/frontend/` (Electron desktop) |
| **Workflow** | User t·∫°o spec ‚Üí agents t·ª± plan, build, validate ‚Üí review ‚Üí merge |
| **UI** | Kanban Board + Agent Terminals + Roadmap + Insights |
| **Security** | 3-layer: OS Sandbox ‚Üí Filesystem Restrictions ‚Üí Dynamic Command Allowlist |
| **H·ªØu √≠ch cho ta** | C·∫•u tr√∫c monorepo, kh√°i ni·ªám "spec ‚Üí autonomous execution", Kanban task tracking, CLI mode backup |

### 2. Claude Code Agent Teams (code.claude.com/docs/en/agent-teams)

| ƒê·∫∑c ƒëi·ªÉm | Chi ti·∫øt |
|---|---|
| **K√≠ch ho·∫°t** | `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1` trong settings.json |
| **Ki·∫øn tr√∫c** | Lead session + Teammate sessions, shared task list t·∫°i `~/.claude/tasks/{team-name}/` |
| **Display modes** | In-process (m·∫∑c ƒë·ªãnh) ho·∫∑c Split-pane (tmux/iTerm2) |
| **Giao ti·∫øp** | `message` (1-1), `broadcast` (1-all), auto idle notifications |
| **Task management** | Lead assigns ho·∫∑c teammates self-claim |
| **Quality gates** | Hooks: `TeammateIdle` (exit code 2 ‚Üí keep working), `TaskCompleted` (exit code 2 ‚Üí reject completion) |
| **Gi·ªõi h·∫°n** | Kh√¥ng nested teams, kh√¥ng resume in-process teammates, lead c·ªë ƒë·ªãnh |

---

## Quy·∫øt ƒê·ªãnh Ki·∫øn Tr√∫c

```mermaid
graph TB
    subgraph Desktop["Electron App"]
        Main["Main Process<br/>spawn backend + IPC"]
        Preload["Preload Script<br/>contextBridge"]
    end

    subgraph Renderer["React + Vite + Tailwind"]
        OfficeMap["üè¢ Office Map Canvas"]
        Kanban["üìã Kanban Board"]
        LogChat["üí¨ Log/Chat Viewer"]
        WSClient["üîå WebSocket Client"]
    end

    subgraph Backend["Python FastAPI"]
        ProjectMgr["Project Manager"]
        DeptMgr["Department Manager"]
        AgentOrch["Agent Orchestrator"]
        TaskMgr["Task Manager"]
        ClaudeAdapter["Claude Code Adapter"]
        GitWS["Git Workspace Manager"]
        QAGate["QA Gate Runner"]
        WSServer["WebSocket Server"]
    end

    subgraph Storage["SQLite"]
        DB[(chibi.db)]
    end

    subgraph External["External"]
        ClaudeCLI["Claude Code CLI"]
        Git["Git / Worktrees"]
    end

    Main --> Backend
    Main <--> Preload
    Preload <--> Renderer
    WSClient <--> WSServer
    ClaudeAdapter --> ClaudeCLI
    GitWS --> Git
    Backend --> DB
```

### Tech Stack Ch√≠nh Th·ª©c

| Layer | Technology | L√Ω do |
|---|---|---|
| **Desktop shell** | Electron 35+ | Cross-platform, file dialog, spawn subprocess |
| **Renderer** | React 19 + Vite 7 + Tailwind 4 | Fast HMR, modern styling |
| **Backend** | Python 3.12 + FastAPI + Uvicorn | Async, subprocess management, Claude CLI integration |
| **ORM** | SQLModel (SQLAlchemy wrapper) | Pythonic, type-safe, SQLite-native |
| **Realtime** | FastAPI WebSocket | Lightweight, no external broker needed |
| **Claude integration** | Claude Code CLI subprocess | Official integration path, streaming stdout |
| **Git management** | GitPython + subprocess | Worktree creation, branch management |

---

## C·∫•u Tr√∫c Monorepo Chi Ti·∫øt

```
it-heroes/
‚îú‚îÄ‚îÄ PROJECT_SPEC.md                    # (ƒë√£ c√≥)
‚îú‚îÄ‚îÄ package.json                       # root workspace config
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ backend/                       # Python FastAPI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pyproject.toml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.py                    # FastAPI app entry
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py                  # Settings + env
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py                # SQLite engine + session
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ project.py             # Project model
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ department.py          # Department model
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent.py               # Agent model
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ session.py             # Session model
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task.py                # Task model
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ event_log.py           # EventLog model
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ projects.py            # /projects endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ departments.py         # /departments endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agents.py              # /agents endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks.py               # /tasks endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ qa.py                  # /qa endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ project_service.py     # Project CRUD + scan
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ agent_orchestrator.py  # Spawn/manage agent sessions
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ claude_adapter.py      # Claude CLI subprocess wrapper
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ git_workspace.py       # Worktree/branch management
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ qa_runner.py           # QA gate pipeline
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ task_dispatcher.py     # Task assignment logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ websocket/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manager.py             # ConnectionManager
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ events.py              # Event type definitions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ test_models.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ test_projects.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ test_tasks.py
‚îÇ   ‚îú‚îÄ‚îÄ desktop/                       # Electron main process
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.js                    # Electron entry
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ preload.js                 # contextBridge
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ipc/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file-dialog.js         # Repo picker
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backend-spawn.js       # Spawn uvicorn
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ icon.png
‚îÇ   ‚îî‚îÄ‚îÄ renderer/                      # React frontend
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îú‚îÄ‚îÄ vite.config.js
‚îÇ       ‚îú‚îÄ‚îÄ tailwind.config.js
‚îÇ       ‚îú‚îÄ‚îÄ index.html
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ main.jsx               # React entry
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ App.jsx                # Root layout
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.css              # Global styles + design tokens
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ stores/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useProjectStore.js  # Zustand project state
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAgentStore.js    # Zustand agent state
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useTaskStore.js     # Zustand task state
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useWebSocket.js     # WS connection + event handling
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useApi.js           # REST API wrapper
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Sidebar.jsx     # Projects + Departments nav
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Header.jsx      # Top bar + status
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RightPanel.jsx  # Task detail + logs
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ office/
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OfficeMap.jsx   # Canvas grid view
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Room.jsx        # Department room
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Desk.jsx        # Agent workspace
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChibiAgent.jsx  # Animated chibi character
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kanban/
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ KanbanBoard.jsx # Task board
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ KanbanColumn.jsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TaskCard.jsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LogViewer.jsx   # Realtime log stream
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChatBubble.jsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ       ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Button.jsx
‚îÇ       ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Modal.jsx
‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ StatusBadge.jsx
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ chibi/              # Chibi sprite/images
‚îÇ       ‚îî‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îî‚îÄ‚îÄ shared/                        # Shared types (optional)
‚îÇ       ‚îî‚îÄ‚îÄ types.ts
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md
‚îÇ   ‚îî‚îÄ‚îÄ API.md
‚îú‚îÄ‚îÄ .chibi/
‚îÇ   ‚îî‚îÄ‚îÄ departments.yml                # Department policy config
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ dev.sh                         # Start all services
    ‚îî‚îÄ‚îÄ setup.sh                       # Initial setup
```

---

## Sprint Breakdown Chi Ti·∫øt

### Sprint 1 ‚Äî MVP Core (Tu·∫ßn 1‚Äì2)

> **M·ª•c ti√™u**: Electron ch·∫°y ƒë∆∞·ª£c, ch·ªçn repo, scan folders t·∫°o rooms, UI Office Map + Kanban, WebSocket realtime.

#### Phase 1A: Backend Foundation

##### [NEW] [pyproject.toml](file:///Users/hainc/claudebot/it-heroes/apps/backend/pyproject.toml)
- Python project config, dependencies: `fastapi`, `uvicorn`, `sqlmodel`, `gitpython`, `websockets`

##### [NEW] [main.py](file:///Users/hainc/claudebot/it-heroes/apps/backend/main.py)
- FastAPI app initialization, CORS middleware, router includes, startup/shutdown events
- Mount WebSocket endpoint

##### [NEW] [database.py](file:///Users/hainc/claudebot/it-heroes/apps/backend/database.py)
- SQLite engine via SQLModel
- `create_db_and_tables()` on startup
- Session dependency injection

##### [NEW] models/ (6 files)
- `Project`, `Department`, `Agent`, `Session`, `Task`, `EventLog`
- Enum types: `TaskStatus`, `AgentRole`
- Relationships via SQLModel

##### [NEW] routers/projects.py
- `POST /projects` ‚Äî t·∫°o project t·ª´ repo_path
- `GET /projects` ‚Äî list all
- `GET /projects/{id}` ‚Äî detail
- `POST /projects/{id}/departments/scan` ‚Äî scan repo folders ‚Üí create departments

##### [NEW] routers/tasks.py
- `POST /projects/{id}/tasks` ‚Äî t·∫°o task
- `PATCH /tasks/{id}` ‚Äî update task status
- `GET /projects/{id}/tasks` ‚Äî list tasks by project

##### [NEW] websocket/manager.py
- `ConnectionManager` class: connect, disconnect, broadcast
- Event types: `agent.status`, `task.updated`, `log.append`, `room.occupancy`

---

#### Phase 1B: Electron Shell

##### [NEW] apps/desktop/package.json
- Electron 35+, electron-builder

##### [NEW] apps/desktop/main.js
- Create BrowserWindow ‚Üí load renderer (Vite dev server ho·∫∑c built files)
- Spawn Python backend (uvicorn) as child process
- Graceful shutdown: kill backend on app quit

##### [NEW] apps/desktop/preload.js
- `contextBridge.exposeInMainWorld('chibiAPI', { ... })`
- IPC handlers: selectRepo, getBackendPort

##### [NEW] apps/desktop/ipc/file-dialog.js
- `dialog.showOpenDialog()` ‚Üí ch·ªçn repo folder
- Validate: check `.git` folder exists

##### [NEW] apps/desktop/ipc/backend-spawn.js
- Spawn `uvicorn main:app --port {dynamic_port}`
- Health check polling until backend ready
- Error handling + restart logic

---

#### Phase 1C: React Renderer

##### [NEW] apps/renderer/ (Vite + React + Tailwind setup)
- `npm create vite@latest ./ -- --template react`
- Install: `zustand`, `tailwindcss`, `@tailwindcss/vite`

##### [NEW] src/index.css
- Design system: dark theme, neon accents, glassmorphism
- CSS variables cho chibi office aesthetic
- Grid layouts, animations

##### [NEW] src/App.jsx
- 3-column layout: Sidebar | OfficeMap/Kanban | RightPanel
- Tab switching: Office View ‚Üî Kanban View

##### [NEW] src/stores/ (3 Zustand stores)
- `useProjectStore`: selected project, departments list
- `useAgentStore`: agents map, status updates
- `useTaskStore`: tasks per department, CRUD operations

##### [NEW] src/hooks/useWebSocket.js
- Connect to `ws://localhost:{port}/ws/projects/{id}`
- Auto-reconnect with exponential backoff
- Dispatch events to Zustand stores

##### [NEW] src/components/layout/Sidebar.jsx
- Projects list + Departments tree
- Click to select ‚Üí update office map

##### [NEW] src/components/office/OfficeMap.jsx
- CSS Grid canvas showing department rooms
- Each room shows agents as chibi characters
- Status-driven animations

##### [NEW] src/components/office/ChibiAgent.jsx
- Chibi character component v·ªõi status animations:
  - `idle` ‚Üí ng·ªìi ch·ªù (breathing animation)
  - `in_progress` ‚Üí g√µ m√°y (typing animation)
  - `blocked` ‚Üí ƒë·ª©ng k·∫πt (shake animation)
  - `review` ‚Üí c·∫ßm k√≠nh l√∫p (magnify animation)
  - `failed` ‚Üí m·∫∑t bu·ªìn (sad pulse)
  - `done` ‚Üí ƒÉn m·ª´ng (bounce + particles)

##### [NEW] src/components/kanban/KanbanBoard.jsx
- Columns: Todo ‚Üí In Progress ‚Üí Blocked ‚Üí Review ‚Üí Done ‚Üí Failed
- Drag-and-drop (dnd-kit)
- TaskCard with agent avatar, status badge

##### [NEW] src/components/logs/LogViewer.jsx
- Scrollable log stream
- Auto-scroll to bottom
- Color-coded by log type

**Sprint 1 Acceptance Criteria:**
- [x] User m·ªü app ‚Üí Electron window hi·ªán
- [x] Ch·ªçn repo folder ‚Üí backend scan ‚Üí rooms hi·ªÉn th·ªã
- [x] T·∫°o task ‚Üí hi·ªán tr√™n Kanban
- [x] WebSocket push events ‚Üí UI update realtime

---

### Sprint 2 ‚Äî Multi-Agent Orchestration (Tu·∫ßn 3‚Äì4)

> **M·ª•c ti√™u**: Start lead + teammates, dispatch tasks theo ph√≤ng ban, worktree per agent, realtime monitoring.

#### Phase 2A: Claude Code Integration

##### [NEW] services/claude_adapter.py
- `ClaudeCodeAdapter` class:
  - `start_session(agent_id, role, prompt)` ‚Üí spawn `claude` CLI subprocess
  - `stream_output(process)` ‚Üí async generator yielding log lines
  - `stop_session(agent_id)` ‚Üí graceful termination
  - `set_team_mode()` ‚Üí configure `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1`
- Fallback strategy: n·∫øu Agent Teams fail ‚Üí single-agent mode sequential

##### [NEW] services/agent_orchestrator.py
- `AgentOrchestrator` class:
  - `summon_team(project_id, team_config)` ‚Üí create lead + teammates
  - `start_all()` ‚Üí spawn all agent sessions
  - `dispatch_task(task_id, agent_id)` ‚Üí assign + execute
  - `get_team_status()` ‚Üí aggregate all agent statuses
  - `broadcast_event(event)` ‚Üí push to WebSocket
- Session tracking: map agent_id ‚Üí subprocess PID

##### [NEW] services/task_dispatcher.py
- `TaskDispatcher` class:
  - `breakdown_goal(goal_text)` ‚Üí use lead agent to create sub-tasks
  - `auto_assign(tasks, agents)` ‚Üí match by department + role
  - `requeue_failed(task_id)` ‚Üí retry logic

---

#### Phase 2B: Git Workspace Isolation

##### [NEW] services/git_workspace.py
- `GitWorkspaceManager` class:
  - `create_worktree(agent_id, project_path)` ‚Üí `git worktree add worktrees/{agent_id} -b chibi/{project}/{agent_id}`
  - `get_worktree_path(agent_id)` ‚Üí resolve path
  - `create_diff_summary(agent_id)` ‚Üí `git diff` output
  - `export_patch(agent_id)` ‚Üí `git format-patch`
  - `cleanup_worktree(agent_id)` ‚Üí remove worktree + branch
  - `create_merge_plan(agent_ids)` ‚Üí aggregate diffs for lead review

---

#### Phase 2C: Team Management UI

##### [NEW] src/components/office/TeamPanel.jsx
- "Summon Team" button ‚Üí modal with role selection
- Team config: Lead + N teammates (Backend, Frontend, QA, Docs, Security)
- Live status indicators per agent

##### [MODIFY] src/components/office/OfficeMap.jsx
- Agents appear in rooms when spawned
- Status transitions animate in realtime
- Click agent ‚Üí show detail panel

##### [MODIFY] src/components/kanban/KanbanBoard.jsx
- Tasks auto-assigned show agent avatar
- Progress indicators per agent
- Filter by department/agent

##### [NEW] src/components/logs/AgentTerminal.jsx
- Real-time CLI output per agent (styled terminal)
- Scrollback buffer
- Copy/search functionality

**Sprint 2 Acceptance Criteria:**
- [x] "Summon Team" ‚Üí lead + 2-3 teammates spawn visually
- [x] M·ªói agent c√≥ worktree ri√™ng (verify `git worktree list`)
- [x] Lead ph√¢n c√¥ng tasks ‚Üí agents nh·∫≠n task ‚Üí status ƒë·ªïi realtime
- [x] Agent terminal output hi·ªán logs streaming

---

### Sprint 3 ‚Äî QA Gate + Polish (Tu·∫ßn 5‚Äì6)

> **M·ª•c ti√™u**: QA pipeline per department, policy files, chibi animations premium, UI polish.

#### Phase 3A: QA Gate System

##### [NEW] services/qa_runner.py
- `QARunner` class:
  - `load_policy(department_id)` ‚Üí parse `.chibi/departments.yml`
  - `run_gate(department_id)` ‚Üí execute lint/test commands sequentially
  - `emit_status(step, result)` ‚Üí realtime QA feedback via WebSocket
  - `evaluate_results()` ‚Üí pass/fail determination
  - `block_merge_on_failure()` ‚Üí prevent merge plan if QA fails

##### [NEW] routers/qa.py
- `POST /projects/{id}/qa/run` ‚Üí trigger QA gate
- `GET /projects/{id}/qa/status` ‚Üí current QA state
- `GET /projects/{id}/qa/report` ‚Üí full QA report

##### [MODIFY] services/agent_orchestrator.py
- Integrate QA gate v√†o merge plan flow
- QA fail ‚Üí tasks chuy·ªÉn `blocked`/`failed`
- QA pass ‚Üí enable merge suggestion

---

#### Phase 3B: Department Policies

##### [NEW] config loader for `.chibi/departments.yml`
- Parse YAML policy files
- Per-department: allowed commands, lint/test commands, prompt template hints
- Hot-reload: watch file changes ‚Üí update policies without restart
- Validation: ensure commands are in allowlist

---

#### Phase 3C: Chibi Animations & UI Polish

##### Chibi Sprite System
- T·∫°o ho·∫∑c generate chibi sprites cho m·ªói role (Lead, Backend, Frontend, QA, Docs, Security)
- CSS animations per status (idle/working/blocked/review/done/failed)
- Smooth transitions gi·ªØa c√°c states

##### UI Premium Elements
- Glassmorphism panels
- Neon glow effects cho active agents
- Particle effects khi agent ho√†n th√†nh task
- Smooth drag-and-drop v·ªõi spring animations
- Dark theme v·ªõi gradient backgrounds
- Responsive layout (resize-friendly)

##### Sound Effects (optional)
- Task complete chime
- Agent status change sounds
- Notification sounds

**Sprint 3 Acceptance Criteria:**
- [x] QA gate ch·∫°y lint/test ‚Üí emit realtime results
- [x] QA fail ‚Üí tasks blocked, merge plan b·ªã ch·∫∑n
- [x] Policy file thay ƒë·ªïi ‚Üí QA rules update kh√¥ng c·∫ßn restart
- [x] Chibi animations smooth cho t·∫•t c·∫£ 6 statuses
- [x] UI look premium, glassmorphism, neon effects

---

## S∆° ƒê·ªì Data Flow

```mermaid
sequenceDiagram
    participant User
    participant Electron
    participant FastAPI
    participant SQLite
    participant ClaudeCLI
    participant Git

    User->>Electron: Ch·ªçn repo folder
    Electron->>FastAPI: POST /projects {repo_path}
    FastAPI->>SQLite: Create Project
    FastAPI->>FastAPI: Scan folders
    FastAPI->>SQLite: Create Departments
    FastAPI-->>Electron: Project + Departments

    User->>Electron: "Summon Team"
    Electron->>FastAPI: POST /projects/{id}/team/start
    FastAPI->>Git: Create worktrees per agent
    FastAPI->>ClaudeCLI: Spawn Claude sessions
    FastAPI-->>Electron: WS: agent.status (spawning)

    User->>Electron: Nh·∫≠p Goal
    Electron->>FastAPI: POST /projects/{id}/tasks
    FastAPI->>ClaudeCLI: Lead breakdown goal
    FastAPI->>SQLite: Create sub-tasks
    FastAPI-->>Electron: WS: task.updated

    loop Per Agent
        ClaudeCLI->>FastAPI: stdout streaming
        FastAPI-->>Electron: WS: log.append
        FastAPI->>SQLite: Update task status
        FastAPI-->>Electron: WS: agent.status
    end

    User->>Electron: "Run QA"
    Electron->>FastAPI: POST /projects/{id}/qa/run
    FastAPI->>FastAPI: Execute lint/test per dept
    FastAPI-->>Electron: WS: qa.status
    FastAPI->>SQLite: Update QA results
```

---

## R·ªßi Ro & Gi·∫£m Thi·ªÉu

| R·ªßi ro | M·ª©c ƒë·ªô | Gi·∫£m thi·ªÉu |
|---|---|---|
| Agent Teams experimental, c√≥ th·ªÉ thay ƒë·ªïi API | üî¥ Cao | Fallback single-agent mode; abstract CLI calls qua adapter layer |
| Parsing CLI stdout d·ªÖ v·ª° n·∫øu format thay ƒë·ªïi | üü° Trung b√¨nh | L∆∞u raw logs + parse t·ªëi thi·ªÉu; regex patterns c√≥ fallback |
| Git conflict khi nhi·ªÅu agent s·ª≠a c√πng file | üü° Trung b√¨nh | Worktree per agent + Lead merge; policy restrict file scope |
| Performance Electron v·ªõi nhi·ªÅu WS updates | üü° Trung b√¨nh | Debounce UI updates (100ms); virtual list cho logs |
| SQLite lock khi concurrent writes | üü¢ Th·∫•p | WAL mode; serialize writes qua service layer |
| Claude CLI kh√¥ng available tr√™n m√°y user | üü¢ Th·∫•p | Check tr∆∞·ªõc khi start; hi·ªÉn th·ªã h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t |

---

## Verification Plan

### Automated Tests

#### Backend (pytest)
```bash
cd apps/backend
python -m pytest tests/ -v
```
- `test_models.py`: Verify t·∫•t c·∫£ models t·∫°o ƒë∆∞·ª£c, relationships ƒë√∫ng
- `test_projects.py`: CRUD projects, scan departments
- `test_tasks.py`: Task CRUD, status transitions
- `test_websocket.py`: WS connection, event broadcasting

#### Frontend (Vitest)
```bash
cd apps/renderer
npx vitest run
```
- Component rendering tests cho Sidebar, OfficeMap, KanbanBoard
- Store tests cho Zustand state management
- WebSocket hook tests

### Manual Verification

1. **M·ªü app** ‚Üí Electron window hi·ªán v·ªõi dark theme
2. **Ch·ªçn repo** ‚Üí File dialog m·ªü, ch·ªçn folder c√≥ `.git`
3. **Scan departments** ‚Üí Rooms hi·ªán tr√™n Office Map
4. **T·∫°o task** ‚Üí Task card hi·ªán tr√™n Kanban
5. **Summon Team** ‚Üí Chibi agents xu·∫•t hi·ªán trong rooms
6. **Agent work** ‚Üí Status animations ch·∫°y, logs streaming
7. **QA Gate** ‚Üí Ch·∫°y lint/test ‚Üí k·∫øt qu·∫£ realtime
8. **Policy change** ‚Üí S·ª≠a `.chibi/departments.yml` ‚Üí QA rules update

> [!TIP]
> Recommend user ki·ªÉm tra t·ª´ng Sprint deliverable tr∆∞·ªõc khi chuy·ªÉn Sprint ti·∫øp theo.

---

## Timeline ∆Ø·ªõc T√≠nh

| Sprint | Th·ªùi gian | Focus |
|---|---|---|
| Sprint 1 | 2 tu·∫ßn | MVP: Electron + Backend + UI c∆° b·∫£n + WS |
| Sprint 2 | 2 tu·∫ßn | Multi-agent: Claude CLI + Worktrees + Team UI |
| Sprint 3 | 2 tu·∫ßn | QA Gate + Policies + Animations + Polish |
| **T·ªïng** | **6 tu·∫ßn** | Full MVP product |
